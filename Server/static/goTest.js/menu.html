<!DOCTYPE html>
<html lang="fr">
<head>
    <script src="https://unpkg.com/gojs/release/go.js"></script>
</head>
<body>
    <div id="myDiagramDiv" style="width: 800px; height: 600px; border: 1px solid black;"></div>

    <script>
        function init() {
            var $ = go.GraphObject.make;

            var myDiagram = $(go.Diagram, "myDiagramDiv", {
                "undoManager.isEnabled": true,
                contextMenu: $(go.Adornment, "Vertical",
                    $("ContextMenuButton",
                        $(go.TextBlock, "Ajouter un nœud"),
                        { click: (e, obj) => addNode(e) }
                    )
                )
            });

            let selectedNode = null; // Stocke le premier nœud sélectionné pour ajouter un lien

            // Modèle de nœud avec menu contextuel
            myDiagram.nodeTemplate =
                $(go.Node, "Auto",
                    { contextMenu: $(go.Adornment, "Vertical",
                        $("ContextMenuButton",
                            $(go.TextBlock, "Supprimer le nœud"),
                            { click: (e, obj) => removeNode(obj) }
                        ),
                        $("ContextMenuButton",
                            $(go.TextBlock, "Ajouter un lien"),
                            { click: (e, obj) => startLink(obj) }
                        ),
                        $("ContextMenuButton",
                            $(go.TextBlock, "Changer la logique"),
                            { click: (e, obj) => changeLogic(obj) }
                        )
                    ) },
                    $(go.Shape, "Ellipse", { fill: "lightblue" }),
                    $(go.TextBlock, { margin: 5 }, new go.Binding("text", "key"))
                );

            // Modèle de lien avec menu contextuel
            myDiagram.linkTemplate =
                $(go.Link,
                    { routing: go.Link.Orthogonal, corner: 5, selectable: true },
                    { contextMenu: $(go.Adornment, "Vertical",
                        $("ContextMenuButton",
                            $(go.TextBlock, "Supprimer le lien"),
                            { click: (e, obj) => removeLink(obj) }
                        )
                    ) },
                    $(go.Shape),
                    $(go.Shape, { toArrow: "Standard" })
                );

            myDiagram.model = new go.GraphLinksModel([
                { key: "A" }, { key: "B" }
            ], [
                { from: "A", to: "B" }
            ]);

            function addNode(e) {
                myDiagram.startTransaction("ajouter un nœud");
                var newNode = { key: "N" + myDiagram.model.nodeDataArray.length };
                myDiagram.model.addNodeData(newNode);
                myDiagram.commitTransaction("ajouter un nœud");
            }

            function removeNode(obj) {
                myDiagram.startTransaction("supprimer un nœud");
                myDiagram.model.removeNodeData(obj.part.data);
                myDiagram.commitTransaction("supprimer un nœud");
            }

            function startLink(obj) {
                if (selectedNode === null) {
                    selectedNode = obj.part.data.key; // Stocke le premier nœud
                    // alert("Sélectionnez un deuxième nœud pour créer un lien.");
                } else {
                    let secondNode = obj.part.data.key;
                    if (selectedNode !== secondNode) {
                        myDiagram.startTransaction("ajouter un lien");
                        myDiagram.model.addLinkData({ from: selectedNode, to: secondNode });
                        myDiagram.commitTransaction("ajouter un lien");
                    } else {
                        alert("Impossible de créer un lien avec le même nœud.");
                    }
                    selectedNode = null; // Réinitialise la sélection
                }
            }

            function changeLogic(obj) {
                alert("Changer la logique du nœud " + obj.part.data.key);
            }

            function removeLink(obj) {
                myDiagram.startTransaction("supprimer un lien");
                myDiagram.model.removeLinkData(obj.part.data);
                myDiagram.commitTransaction("supprimer un lien");
            }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
